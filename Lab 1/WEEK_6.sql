create database companyDB;
use companyDB;

CREATE TABLE DEPT(
DEPTNO INT PRIMARY KEY,
DNAME VARCHAR(30),
DLOC VARCHAR(30));

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(50),
    MGR_NO INT,
    HIREDATE DATE,
    SAL DECIMAL(10,2),
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PLOC VARCHAR(50),
    PNAME VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT DECIMAL(10,2),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);

INSERT INTO DEPT VALUES
(10,'HR',"Bengaluru"),
(20,'Finance',"Hyderabad"),
(30,'IT',"Mysuru"),
(40,'Marketing',"Chennai"),
(50,'Admin',"Delhi");

INSERT INTO EMPLOYEE VALUES
(101,"Ravi",NULL,"2022-01-15",55000,10),
(102,'Priya',101,"2021-03-10",60000,20),
(103,'Kiran',102,"2019-07-21",75000,30),
(104,'Sneha',103,"2022-02-01",50000,40),
(105,'Arjun',104,"2020-09-17",62000,50);

INSERT INTO PROJECT VALUES
(201,"Bangaluru","Payroll System"),
(202,"Hyderabad","Banking App"),
(203,"Mysuru","E-Commerce"),
(204,"Chennai","Marketing Analysis"),
(205,"Delhi","HR Portal");

INSERT INTO ASSIGNED_TO VALUES
(101,201,'Manager'),
(102,202,'Developer'),
(103,203,'Analyst'),
(104,204,'Designer'),
(105,205,'Tester');

INSERT INTO INCENTIVES VALUES
(101,"2024-01-10",5000),
(103,"2024-01-15",3000),
(104,"2024-03-20",2000);


SELECT E.ENAME AS Manager_Name
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.EMPNO = M.MGR_NO
GROUP BY E.ENAME
HAVING COUNT(M.EMPNO) = (
    SELECT MAX(COUNT_SUB)
    FROM (
        SELECT COUNT(M1.EMPNO) AS COUNT_SUB
        FROM EMPLOYEE E1
        JOIN EMPLOYEE M1 ON E1.EMPNO = M1.MGR_NO
        GROUP BY E1.EMPNO
    ) AS TEMP
);

SELECT DISTINCT M.ENAME AS Manager_Name
FROM EMPLOYEE M
JOIN EMPLOYEE E ON M.EMPNO = E.MGR_NO
GROUP BY M.EMPNO, M.ENAME, M.SAL
HAVING M.SAL > AVG(E.SAL);

SELECT E.ENAME AS Second_Level_Manager, D.DNAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE M.MGR_NO IS NULL;

SELECT E.*
FROM EMPLOYEE E
JOIN INCENTIVES I ON E.EMPNO = I.EMPNO
WHERE MONTH(I.INCENTIVE_DATE) = 1
  AND YEAR(I.INCENTIVE_DATE) = 2019
  AND I.INCENTIVE_AMOUNT = (
      SELECT MAX(INCENTIVE_AMOUNT)
      FROM INCENTIVES
      WHERE MONTH(INCENTIVE_DATE) = 1
        AND YEAR(INCENTIVE_DATE) = 2019
        AND INCENTIVE_AMOUNT < (
            SELECT MAX(INCENTIVE_AMOUNT)
            FROM INCENTIVES
            WHERE MONTH(INCENTIVE_DATE) = 1
              AND YEAR(INCENTIVE_DATE) = 2019
        )
  );

SELECT E.ENAME AS Employee_Name, M.ENAME AS Manager_Name, D.DNAME
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.DEPTNO = M.DEPTNO;



